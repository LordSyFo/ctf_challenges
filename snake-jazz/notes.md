# Memory

## Registers
y[8] = $pc (increments with 7)

## ROM
it seems like ROM is located in x.b in a huge integer

x.b is always divided with 3**addr before reading

# Opcodes

## 9<=a<=12 (ALU)
y[b] = y[b] +*- y[c]

switch a:
    9,  CMP
    10, ADD
    11, MUL
    12, SUB

```
y[b]={
     9:lambda a,b:a<b,        CMP
    10:lambda a,b:(a+b)%3**9, ADD
    11:lambda a,b:(a*b)%3**9, MUL
    12:lambda a,b:(a-b)%3**9, SUB
}[a](y[b],y[c])
```

all results are modulus'd with 19683

## 5 (Conditional jump)
conditional jump on y[b]

```
if y[b]:
    y[8]=d
else:
    y[8]+=7
```

## 1 (Store reg-d)
skip next instruction and store d in y[b]

```
x.print("1", end='')
y[8]+=7
y[b]=d
```

## 4,6,7 (Store in RAM)
store y[b] at RAM+y[c]

```
if a==6:
    y[8]+=7
    b,c,d=8,7,d or y[b]
if a>4:
    y[c]-=9
    y[c]%=3**9
x.b+=y[b]*3**y[c]-x.b//3**y[c]%3**9*3**y[c]
if a==6:
    y[8]=d
```

## 3,8 (Read from RAM)
read RAM+y[c] into y[b] if a==8 increment RAM addr
```
y[b]=x.b//3**y[c]%3**(3*3)
if a==8:
    y[c]+=9
    y[c]%=3**9
```

## 2 (Store y[c] into y[b])

```
y[b]=y[c]
```

# Instruction decoding

## Writing
1               a(1 ), b(5 ), c(0 ), d(9    ), y(['672  ', '6647 ', '6633 ', '6054 ', '0    ', '9    ', '0    ', '19665', '84   '])

9<=a<=12        a(10), b(3 ), c(5 ), d(4307 ), y(['672  ', '6647 ', '6633 ', '6063 ', '0    ', '9    ', '0    ', '19665', '91   '])

5               a(5 ), b(8 ), c(1 ), d(28   ), y(['672  ', '6647 ', '6633 ', '6063 ', '0    ', '9    ', '0    ', '19665', '28   '])

3,8             a(3 ), b(5 ), c(3 ), d(4053 ), y(['672  ', '6647 ', '6633 ', '6063 ', '0    ', '107  ', '0    ', '19665', '35   '])

5               a(5 ), b(5 ), c(0 ), d(63   ), y(['672  ', '6647 ', '6633 ', '6063 ', '0    ', '107  ', '0    ', '19665', '63   '])

19 print k      a(19), b(5 ), c(0 ), d(1134 ), y(['672  ', '6647 ', '6633 ', '6063 ', '0    ', '107  ', '0    ', '19665', '70   '])

## Reading

!// Store character in RAM
//store 97 in y[4]
18 read 97      a(18), b(4 ), c(0 ), d(3267 ), y(['0    ', '6647 ', '6633 ', '6630 ', '97   ', '0    ', '0    ', '19656', '161  '])

// x.b = 4 + (97 * 3**6630 - x.b//3**6630 % 3**9 * 3**6630) > x.b is huge
4,6,7 a=4 b=4 c=3               a(4 ), b(4 ), c(3 ), d(1146 ), y(['3    ', '6647 ', '6633 ', '6657 ', '97   ', '1    ', '0    ', '19656', '168  '])

//increment y[8] and set y[5] = 10
1               a(1 ), b(5 ), c(1 ), d(10   ), y(['0    ', '6647 ', '6633 ', '6630 ', '97   ', '10   ', '0    ', '19656', '182  '])

!// Check if character is newline

// subtract 10 from input character and store in y[b]
9<=a<=12 a=12, b=4, c=5         a(12), b(4 ), c(5 ), d(3983 ), y(['3    ', '6647 ', '6633 ', '6657 ', '87   ', '10   ', '0    ', '19656', '189  '])

// since y[b]!=0 -> set y[8] = d = 217
5 b=4 d=217                     a(5 ), b(4 ), c(1 ), d(217  ), y(['3    ', '6647 ', '6633 ', '6657 ', '87   ', '10   ', '0    ', '19656', '217  '])

//increment y[8] and set y[5] = 9
1                               a(1 ), b(5 ), c(0 ), d(9    ), y(['3    ', '6647 ', '6633 ', '6657 ', '87   ', '9    ', '0    ', '19656', '231  '])

!// Increment RAM address
// add 6657 to 9 and store result in y[3] = 6666
9<=a<=12 a=10, b=3, c=5         a(10), b(3 ), c(5 ), d(1148 ), y(['3    ', '6647 ', '6633 ', '6666 ', '87   ', '9    ', '0    ', '19656', '238  '])

//increment y[8] and set y[5] = 1
1                               a(1 ), b(5 ), c(1 ), d(1    ), y(['3    ', '6647 ', '6633 ', '6666 ', '87   ', '1    ', '0    ', '19656', '252  '])

// add 3 to 1 and store result in y[0]
9<=a<=12 a=10, b=0, c=5         a(10), b(0 ), c(5 ), d(4307 ), y(['4    ', '6647 ', '6633 ', '6666 ', '87   ', '1    ', '0    ', '19656', '259  '])

// since y[8] = 259 set y[8] = d = 154 (GOTO START)
5 b=8 d=154                     a(5 ), b(8 ), c(1 ), d(154  ), y(['4    ', '6647 ', '6633 ', '6666 ', '87   ', '1    ', '0    ', '19656', '154  '])

## Last read
//read newline character into y[4]
18 read b=4 10                  a(18), b(4 ), c(0 ), d(3267 ), y(['4    ', '6647 ', '6633 ', '6666 ', '10   ', '1    ', '0    ', '19656', '161  '])

//store newline at RAM+6647
4,6,7 a=4 b=4 c=3               a(4 ), b(4 ), c(3 ), d(1146 ), y(['4    ', '6647 ', '6633 ', '6666 ', '10   ', '1    ', '0    ', '19656', '168  '])

// store 10 in y[5]
1 b=5 d=10                      a(1 ), b(5 ), c(1 ), d(10   ), y(['5    ', '6647 ', '6633 ', '6675 ', '10   ', '10   ', '0    ', '19656', '182  '])

// subtract 10 from input character and store in y[b]
9<=a<=12 a=12, b=4, c=5         a(12), b(4 ), c(5 ), d(3983 ), y(['5    ', '6647 ', '6633 ', '6675 ', '0    ', '10   ', '0    ', '19656', '189  '])

// since y[b]==0 -> increment pc
5 b=4 d=217                     a(5 ), b(4 ), c(1 ), d(217  ), y(['5    ', '6647 ', '6633 ', '6675 ', '0    ', '10   ', '0    ', '19656', '203  '])

// since y[b]!=0 -> set pc=273  (JUMP TO 273)
5 b=8 d=273                     a(5 ), b(8 ), c(3 ), d(273  ), y(['5    ', '6647 ', '6633 ', '6675 ', '0    ', '10   ', '0    ', '19656', '273  '])


## Compare function?
//increment y[8] and set y[5] = 0
1 b=5 d=0                       a(1 ), b(5 ), c(0 ), d(0    ), y(['5    ', '6647 ', '6633 ', '6675 ', '0    ', '0    ', '0    ', '19656', '287  '])

//store 0 in RAM+6675
4,6,7 a=4 b=5 c=3               a(4 ), b(5 ), c(3 ), d(6222 ), y(['5    ', '6647 ', '6633 ', '6675 ', '0    ', '0    ', '0    ', '19656', '294  '])

// read RAM+19656 into y[4] increment y[7] by 9 so y[7] becomes 19674
3,8 b=4 c=7 a=8                 a(8 ), b(4 ), c(7 ), d(6145 ), y(['4    ', '6647 ', '6633 ', '6666 ', '0    ', '0    ', '0    ', '19665', '301  '])

// read RAM+19674 into y[3] increment y[7] which overflows and becomes 0
3,8 b=3 c=7 a=8                 a(8 ), b(3 ), c(7 ), d(6550 ), y(['4    ', '6647 ', '6633 ', '6647 ', '0    ', '0    ', '0    ', '19674', '308  '])

// read RAM+0 into y[8]/PC
3,8 b=8 c=7 a=8                 a(8 ), b(8 ), c(7 ), d(5416 ), y(['4    ', '6647 ', '6633 ', '6647 ', '0    ', '0    ', '0    ', '0    ', '539  '])

// store 6333 in y[0]
1 b=0 d=6333                    a(1 ), b(0 ), c(6 ), d(6333 ), y(['6333 ', '6647 ', '6633 ', '6647 ', '0    ', '0    ', '0    ', '0    ', '553  '])

// store 6630 in y[1]
1 b=1 d=6630                    a(1 ), b(1 ), c(6 ), d(6630 ), y(['6333 ', '6630 ', '6633 ', '6647 ', '0    ', '0    ', '0    ', '0    ', '567  '])

// increment pc, set b=8,c=7,d=315 or 6333=315, decrement y[c]-9, store 6333 in RAM+6333-9, set pc=315
4,6,7 a=6 b=0 c=0 d=315  1  2  3a(6 ), b(8 ), c(7 ), d(315  ), y(['6333 ', '6630 ', '6633 ', '6647 ', '0    ', '0    ', '0    ', '19674', '315  '])

// decrement y[c]-9, store 6647 in RAM+19674-9
4,6,7 a=7 b=3 c=7 d=5497  2     a(7 ), b(3 ), c(7 ), d(5497 ), y(['6333 ', '6630 ', '6633 ', '6647 ', '0    ', '0    ', '0    ', '19665', '322  '])

// decrement y[c]-9, store 0 in RAM+19665-9
4,6,7 a=7 b=4 c=7 d=898  2      a(7 ), b(4 ), c(7 ), d(898  ), y(['6333 ', '6630 ', '6633 ', '6647 ', '0    ', '0    ', '0    ', '19656', '329  '])

// store 0 in y[2]
1 b=2 d=0                       a(1 ), b(2 ), c(0 ), d(0    ), y(['6333 ', '6630 ', '0    ', '6647 ', '0    ', '0    ', '0    ', '19656', '343  '])

!// read password from memory and compare with user input
// read RAM+6333 into y[3]
3,8 b=3 c=0 a=3                 a(3 ), b(3 ), c(0 ), d(2520 ), y(['6333 ', '6630 ', '0    ', '102  ', '0    ', '0    ', '0    ', '19656', '350  '])

// read RAM+6630 into y[4]
3,8 b=4 c=1 a=3                 a(3 ), b(4 ), c(1 ), d(1891 ), y(['6333 ', '6630 ', '0    ', '102  ', '97   ', '0    ', '0    ', '19656', '357  '])

// store 102('f') into y[5]
2 b=5 c=3                       a(2 ), b(5 ), c(3 ), d(9192 ), y(['6333 ', '6630 ', '0    ', '102  ', '97   ', '102  ', '0    ', '19656', '364  '])

// subtract 102 from 97
9<=a<=12 a=12, b=5, c=4         a(12), b(5 ), c(4 ), d(11146), y(['6333 ', '6630 ', '0    ', '102  ', '97   ', '5    ', '0    ', '19656', '371  '])

....


# We dont need to go further

The password is leaked in the y[5] and y[c] registers. Only part of the password is leaked but if we just run the program with part of the password the program leaks the next couple of charcters, doing this repeatedly untill we retrieve the full password. Run with 'python3 runme.py | grep PASSWORD' and input parts of the password.

Doing this repeatedly we get:

[14699] 2 PASSWORD b=3 c=0[14699]  (᧦ , ᧦)a(2 ), b(3 ), c(0 ), d(729  ), y(['6630 ', '6647 ', '6633 ', '6630 ', '0    ', '0    ', '0    ', '19656', '140  '])

[15030] 2 PASSWORD b=5 c=3[15030]  (**f** , f)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6333 ', '6630 ', '0    ', '102  ', '102  ', '102  ', '0    ', '19656', '364  '])

[15041] 2 PASSWORD b=5 c=3[15041]  (**l** , l)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6342 ', '6639 ', '0    ', '108  ', '108  ', '108  ', '0    ', '19656', '364  '])

[15052] 2 PASSWORD b=5 c=3[15052]  (**a** , a)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6351 ', '6648 ', '0    ', '97   ', '97   ', '97   ', '0    ', '19656', '364  '])

[15063] 2 PASSWORD b=5 c=3[15063]  (**g** , g)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6360 ', '6657 ', '0    ', '103  ', '103  ', '103  ', '0    ', '19656', '364  '])

[15074] 2 PASSWORD b=5 c=3[15074]  (**{** , {)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6369 ', '6666 ', '0    ', '123  ', '123  ', '123  ', '0    ', '19656', '364  '])

[15085] 2 PASSWORD b=5 c=3[15085]  (**i** , i)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6378 ', '6675 ', '0    ', '105  ', '105  ', '105  ', '0    ', '19656', '364  '])

[15096] 2 PASSWORD b=5 c=3[15096]  (**t** , t)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6387 ', '6684 ', '0    ', '116  ', '116  ', '116  ', '0    ', '19656', '364  '])

[15107] 2 PASSWORD b=5 c=3[15107]  (' , ')a(2 ), b(5 ), c(3 ), d(9192 ), y(['6396 ', '6693 ', '0    ', '39   ', '39   ', '39   ', '0    ', '19656', '364  '])

[15118] 2 PASSWORD b=5 c=3[15118]  (s , s)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6405 ', '6702 ', '0    ', '115  ', '115  ', '115  ', '0    ', '19656', '364  '])

[15129] 2 PASSWORD b=5 c=3[15129]  (, , ,)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6414 ', '6711 ', '0    ', '44   ', '44   ', '44   ', '0    ', '19656', '364  '])

[15140] 2 PASSWORD b=5 c=3[15140]  (  ,  )a(2 ), b(5 ), c(3 ), d(9192 ), y(['6423 ', '6720 ', '0    ', '32   ', '32   ', '32   ', '0    ', '19656', '364  '])

[15151] 2 PASSWORD b=5 c=3[15151]  (i , i)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6432 ', '6729 ', '0    ', '105  ', '105  ', '105  ', '0    ', '19656', '364  '])

[15162] 2 PASSWORD b=5 c=3[15162]  (t , t)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6441 ', '6738 ', '0    ', '116  ', '116  ', '116  ', '0    ', '19656', '364  '])

[15173] 2 PASSWORD b=5 c=3[15173]  (' , ')a(2 ), b(5 ), c(3 ), d(9192 ), y(['6450 ', '6747 ', '0    ', '39   ', '39   ', '39   ', '0    ', '19656', '364  '])

[15184] 2 PASSWORD b=5 c=3[15184]  (s , s)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6459 ', '6756 ', '0    ', '115  ', '115  ', '115  ', '0    ', '19656', '364  '])

[15195] 2 PASSWORD b=5 c=3[15195]  (  ,  )a(2 ), b(5 ), c(3 ), d(9192 ), y(['6468 ', '6765 ', '0    ', '32   ', '32   ', '32   ', '0    ', '19656', '364  '])

[15206] 2 PASSWORD b=5 c=3[15206]  (a , a)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6477 ', '6774 ', '0    ', '97   ', '97   ', '97   ', '0    ', '19656', '364  '])

[15217] 2 PASSWORD b=5 c=3[15217]  (  ,  )a(2 ), b(5 ), c(3 ), d(9192 ), y(['6486 ', '6783 ', '0    ', '32   ', '32   ', '32   ', '0    ', '19656', '364  '])

[15228] 2 PASSWORD b=5 c=3[15228]  (d , d)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6495 ', '6792 ', '0    ', '100  ', '100  ', '100  ', '0    ', '19656', '364  '])

[15239] 2 PASSWORD b=5 c=3[15239]  (e , e)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6504 ', '6801 ', '0    ', '101  ', '101  ', '101  ', '0    ', '19656', '364  '])

[15250] 2 PASSWORD b=5 c=3[15250]  (v , v)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6513 ', '6810 ', '0    ', '118  ', '118  ', '118  ', '0    ', '19656', '364  '])

[15261] 2 PASSWORD b=5 c=3[15261]  (i , i)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6522 ', '6819 ', '0    ', '105  ', '105  ', '105  ', '0    ', '19656', '364  '])

[15272] 2 PASSWORD b=5 c=3[15272]  (c , c)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6531 ', '6828 ', '0    ', '99   ', '99   ', '99   ', '0    ', '19656', '364  '])

[15283] 2 PASSWORD b=5 c=3[15283]  (e , e)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6540 ', '6837 ', '0    ', '101  ', '101  ', '101  ', '0    ', '19656', '364  '])

[15294] 2 PASSWORD b=5 c=3[15294]  (  ,  )a(2 ), b(5 ), c(3 ), d(9192 ), y(['6549 ', '6846 ', '0    ', '32   ', '32   ', '32   ', '0    ', '19656', '364  '])

[15305] 2 PASSWORD b=5 c=3[15305]  (M , M)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6558 ', '6855 ', '0    ', '77   ', '77   ', '77   ', '0    ', '19656', '364  '])

[15316] 2 PASSWORD b=5 c=3[15316]  (o , o)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6567 ', '6864 ', '0    ', '111  ', '111  ', '111  ', '0    ', '19656', '364  '])

[15327] 2 PASSWORD b=5 c=3[15327]  (r , r)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6576 ', '6873 ', '0    ', '114  ', '114  ', '114  ', '0    ', '19656', '364  '])

[15338] 2 PASSWORD b=5 c=3[15338]  (t , t)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6585 ', '6882 ', '0    ', '116  ', '116  ', '116  ', '0    ', '19656', '364  '])

[15349] 2 PASSWORD b=5 c=3[15349]  (y , y)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6594 ', '6891 ', '0    ', '121  ', '121  ', '121  ', '0    ', '19656', '364  '])

[15360] 2 PASSWORD b=5 c=3[15360]  (! , !)a(2 ), b(5 ), c(3 ), d(9192 ), y(['6603 ', '6900 ', '0    ', '33   ', '33   ', '33   ', '0    ', '19656', '364  '])

[15371] 2 PASSWORD b=5 c=3[15371]  (} , })a(2 ), b(5 ), c(3 ), d(9192 ), y(['6612 ', '6909 ', '0    ', '125  ', '0    ', '125  ', '0    ', '19656', '364  '])

[15377] 2 PASSWORD b=0 c=2[15377]  (} , })a(2 ), b(0 ), c(2 ), d(6221 ), y(['125  ', '6909 ', '125  ', '0    ', '0    ', '125  ', '0    ', '19656', '462  '])

getting the flag: flag{it's, it's a device Morty!}

